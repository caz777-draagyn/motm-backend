<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youth Academy Workbench</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-size: 14px;
            color: #666;
        }
        
        .controls input,
        .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .controls button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .controls button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .prospects-grid, .academy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prospect-card, .academy-player-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        
        .prospect-card.promoted {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .prospect-card.rejected {
            border-color: #e74c3c;
            background: #fadbd8;
        }
        
        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #3498db;
        }
        
        .player-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .talent-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .talent-elite { background: #f39c12; color: white; }
        .talent-great { background: #3498db; color: white; }
        .talent-good { background: #27ae60; color: white; }
        .talent-mediocre { background: #95a5a6; color: white; }
        .talent-poor { background: #7f8c8d; color: white; }
        
        .potential-range {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .player-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .player-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .attribute-ranges {
            margin-top: 15px;
            font-size: 12px;
        }
        
        .attribute-ranges h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .attribute-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        
        .attribute-item {
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .attr-increased {
            color: #27ae60;
            font-weight: bold;
        }
        
        .attr-decreased {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .attribute-item strong {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .attribute-value {
            font-size: 12px;
            color: #2c3e50;
        }
        
        .academy-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3498db;
        }
        
        .academy-controls select {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .week-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .info-box {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-box strong {
            color: #2c3e50;
        }
        
        /* Development tracking styles */
        .player-development {
            margin-top: 30px;
        }
        
        .players-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .player-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .player-card h4 {
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .player-constant-info {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        
        .player-profile-pic {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #3498db;
            flex-shrink: 0;
        }
        
        .constant-stats {
            font-size: 12px;
            margin-top: 8px;
        }
        
        .constant-stats div {
            margin: 4px 0;
        }
        
        .player-progression-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .player-progression-table th {
            background: #3498db;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
        }
        
        .player-progression-table td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
        }
        
        .player-progression-table tbody tr:hover {
            background: #f5f5f5;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-image {
            max-width: 300px;
            max-height: 300px;
            width: auto;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container" id="logoContainer">
            <!-- Logo will be loaded here -->
        </div>
        <h1>Youth Academy Workbench</h1>
        
        <div class="error" id="errorMsg"></div>
        
        <!-- Section 1: Generate Prospects -->
        <div class="section">
            <h2>1. Generate Prospects</h2>
            <div class="info-box">
                <strong>Capacity:</strong> <span id="capacityInfo">Loading...</span>
            </div>
            <div class="controls">
                <button class="btn-success" onclick="enableTestMode()">Use Test Mode</button>
                <label>Club ID:</label>
                <input type="text" id="clubId" placeholder="Leave empty for test mode" style="width: 250px;">
                
                <label>Game Mode ID:</label>
                <input type="text" id="gameModeId" placeholder="Leave empty for test mode" style="width: 250px;">
                
                <label>Week Number:</label>
                <input type="number" id="weekNumber" value="1" min="1" style="width: 80px;">
                
                <label>Youth Facilities:</label>
                <input type="number" id="youthFacilities" value="5" min="0" max="10" style="width: 80px;">
                
                <label>Number of Prospects:</label>
                <input type="number" id="numProspects" value="8" min="1" max="20" style="width: 80px;">
                
                <label>Player Type:</label>
                <select id="playerType">
                    <option value="false">Outfield</option>
                    <option value="true">Goalkeeper</option>
                </select>
                
                <button onclick="checkCapacity()">Check Capacity</button>
                <button onclick="generateProspects()">Generate Prospects</button>
                <button onclick="loadProspects()">Refresh Prospects</button>
                <button class="btn-danger" onclick="rejectAllProspects()">Reject All Prospects</button>
            </div>
            <div class="controls" style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label>Nationality:</label>
                <select id="nationality" style="width: 120px;">
                    <option value="">Random</option>
                    <option value="ENG" selected>England</option>
                    <option value="FRA">France</option>
                    <option value="NGA">Nigeria</option>
                    <option value="ESP">Spain</option>
                    <option value="ITA">Italy</option>
                    <option value="GER">Germany</option>
                    <option value="BRA">Brazil</option>
                    <option value="ARG">Argentina</option>
                </select>
                
                <label style="margin-left: 15px;">Heritage Options (for testing):</label>
                <label style="margin-left: 5px;">
                    <input type="checkbox" id="heritageENG" style="margin-right: 3px;">
                    ENG
                </label>
                <label style="margin-left: 5px;">
                    <input type="checkbox" id="heritageNGA" style="margin-right: 3px;">
                    NGA
                </label>
            </div>
            <div class="controls" style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label>Min Potential:</label>
                <input type="number" id="minPotential" min="200" max="3000" placeholder="Leave empty for no filter" style="width: 120px;">
                
                <label>Max Potential:</label>
                <input type="number" id="maxPotential" min="200" max="3000" placeholder="Leave empty for no filter" style="width: 120px;">
                
                <label style="margin-left: 15px;">
                    <input type="checkbox" id="usePotentialRange" style="margin-right: 5px;">
                    Use Potential Range Directly (ignore youth facilities distribution)
                </label>
            </div>
            
            <div id="prospectsContainer">
                <div class="prospects-grid" id="prospectsGrid"></div>
            </div>
        </div>
        
        <!-- Section 2: Academy Players -->
        <div class="section">
            <h2>2. Youth Academy Players</h2>
            <div class="controls">
                <button onclick="loadAcademyPlayers()">Refresh Academy Players</button>
                <button class="btn-success" onclick="progressWeek()">Progress All Players by 1 Week</button>
            </div>
            
            <div id="academyContainer">
                <div class="academy-grid" id="academyGrid"></div>
            </div>
        </div>
        
        <!-- Section 3: Promoted Players -->
        <div class="section">
            <h2>3. Promoted Players (Fully Revealed)</h2>
            <div class="controls">
                <button onclick="loadPromotedPlayers()">Refresh Promoted Players</button>
                <button class="btn-success" onclick="trainPromotedPlayers()">Train All Promoted Players for 14 Years</button>
            </div>
            <div class="controls" style="margin-top: 10px;">
                <label>Training Facilities:</label>
                <input type="number" id="trainingFacilities" value="10" min="0" max="10" style="width: 80px;">
                
                <label>Primary Program:</label>
                <select id="primaryProgram">
                    <option value="Balanced" selected>Balanced</option>
                    <option value="Finishing">Finishing</option>
                    <option value="Playmaking">Playmaking</option>
                    <option value="Defending">Defending</option>
                    <option value="Pace & Power">Pace & Power</option>
                    <option value="Aerial">Aerial</option>
                    <option value="Crossing & Wide">Crossing & Wide</option>
                    <option value="Shot-Stopping">Shot-Stopping</option>
                    <option value="Sweeper Keeper">Sweeper Keeper</option>
                    <option value="Aerial/High Claims">Aerial/High Claims</option>
                </select>
                
                <label>Secondary Program:</label>
                <select id="secondaryProgram">
                    <option value="Balanced" selected>Balanced</option>
                    <option value="Finishing">Finishing</option>
                    <option value="Playmaking">Playmaking</option>
                    <option value="Defending">Defending</option>
                    <option value="Pace & Power">Pace & Power</option>
                    <option value="Aerial">Aerial</option>
                    <option value="Crossing & Wide">Crossing & Wide</option>
                    <option value="Shot-Stopping">Shot-Stopping</option>
                    <option value="Sweeper Keeper">Sweeper Keeper</option>
                    <option value="Aerial/High Claims">Aerial/High Claims</option>
                </select>
                
                <label>General Program:</label>
                <select id="generalProgram">
                    <option value="Balanced" selected>Balanced</option>
                    <option value="Finishing">Finishing</option>
                    <option value="Playmaking">Playmaking</option>
                    <option value="Defending">Defending</option>
                    <option value="Pace & Power">Pace & Power</option>
                    <option value="Aerial">Aerial</option>
                    <option value="Crossing & Wide">Crossing & Wide</option>
                    <option value="Shot-Stopping">Shot-Stopping</option>
                    <option value="Sweeper Keeper">Sweeper Keeper</option>
                    <option value="Aerial/High Claims">Aerial/High Claims</option>
                </select>
            </div>
            <div id="academyContainer">
                <div class="academy-grid" id="promotedPlayersGrid"></div>
            </div>
        </div>
        
        <!-- Section 4: Player Development Tracking -->
        <div class="section" id="section4">
            <h2>4. Player Development Tracking</h2>
            <div id="developmentResults" style="display: none;" class="player-development"></div>
        </div>
    </div>
    
    <script>
        let currentClubId = null;
        
        // Position options (from match_engine constants)
        const POSITIONS = ["GK", "DL", "DC", "DR", "DML", "DMC", "DMR", "ML", "MC", "MR", "OML", "OMC", "OMR", "FC"];
        
        // Training programs (from player_development)
        const TRAINING_PROGRAMS_OUTFIELD = ["Balanced", "Finishing", "Playmaking", "Defending", "Pace & Power", "Aerial", "Crossing & Wide"];
        const TRAINING_PROGRAMS_GK = ["Balanced", "Shot-Stopping", "Sweeper Keeper", "Aerial/High Claims"];
        
        // Position traits
        const POSITION_TRAITS = ["Natural Winger", "Deep-Lying Playmaker", "Box-to-Box", "Ball-Playing Defender", "Poacher", "Target Forward", "Wing Back", "Sweeper Keeper"];
        
        // Gainable traits
        const GAINABLE_TRAITS = ["Flair", "Leader", "Big-Game Player", "Workhorse", "Set-Piece Specialist", "Tireless Runner", "Speedster", "Poacher", "Target Man", "Playmaker"];
        
        // Load random profile picture as logo
        async function loadRandomLogo() {
            try {
                const response = await fetch('/api/youth-academy/random-profile-picture');
                if (response.ok) {
                    const data = await response.json();
                    const logoContainer = document.getElementById('logoContainer');
                    if (logoContainer) {
                        logoContainer.innerHTML = `<img src="${data.path}" alt="Logo" class="logo-image">`;
                    }
                }
            } catch (error) {
                // Silently fail if logo can't be loaded
                console.log('Could not load logo:', error);
            }
        }
        
        function showError(msg) {
            const errDiv = document.getElementById('errorMsg');
            errDiv.textContent = msg;
            errDiv.style.display = 'block';
            setTimeout(() => errDiv.style.display = 'none', 5000);
        }
        
        async function checkCapacity() {
            const clubId = document.getElementById('clubId').value.trim() || null;
            const url = clubId ? `/api/youth-academy/capacity/${clubId}` : '/api/youth-academy/capacity';
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to fetch capacity');
                }
                const data = await response.json();
                document.getElementById('capacityInfo').textContent = 
                    `Current: ${data.current} / Capacity: ${data.capacity} (${data.available} available)`;
                
                // Store club ID if test mode was used
                if (!clubId && !currentClubId) {
                    // We'll get it from the response or next generate call
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function generateProspects() {
            const clubId = document.getElementById('clubId').value.trim() || null;
            const gameModeId = document.getElementById('gameModeId').value.trim() || null;
            const weekNumber = parseInt(document.getElementById('weekNumber').value);
            const youthFacilities = parseInt(document.getElementById('youthFacilities').value);
            const numProspects = parseInt(document.getElementById('numProspects').value);
            const isGoalkeeper = document.getElementById('playerType').value === 'true';
            const minPotential = document.getElementById('minPotential').value.trim();
            const maxPotential = document.getElementById('maxPotential').value.trim();
            const usePotentialRange = document.getElementById('usePotentialRange').checked;
            const nationality = document.getElementById('nationality').value.trim() || null;
            
            // Collect heritage options
            const heritageOptions = [];
            if (document.getElementById('heritageENG').checked) {
                heritageOptions.push('ENG');
            }
            if (document.getElementById('heritageNGA').checked) {
                heritageOptions.push('NGA');
            }
            
            const requestBody = {
                club_id: clubId,
                game_mode_id: gameModeId,
                week_number: weekNumber,
                youth_facilities_level: youthFacilities,
                is_goalkeeper: isGoalkeeper,
                num_prospects: numProspects,
                use_potential_range: usePotentialRange
            };
            
            // Add nationality if specified
            if (nationality) {
                requestBody.nationality = nationality;
            }
            
            // Add heritage options if any selected
            if (heritageOptions.length > 0) {
                requestBody.heritage_options = heritageOptions;
            }
            
            // Only include potential range if values are provided
            if (minPotential) {
                requestBody.min_potential = parseInt(minPotential);
            }
            if (maxPotential) {
                requestBody.max_potential = parseInt(maxPotential);
            }
            
            try {
                const response = await fetch('/api/youth-academy/generate-prospects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to generate prospects');
                }
                
                const data = await response.json();
                // Store returned IDs if using test mode
                if (data.club_id && !clubId) {
                    currentClubId = data.club_id;
                    document.getElementById('clubId').value = data.club_id;
                } else if (clubId) {
                    currentClubId = clubId;
                }
                if (data.game_mode_id && !gameModeId) {
                    document.getElementById('gameModeId').value = data.game_mode_id;
                }
                
                await loadProspects();
                await checkCapacity();
            } catch (error) {
                showError(error.message);
            }
        }
        
        function enableTestMode() {
            document.getElementById('clubId').value = '';
            document.getElementById('gameModeId').value = '';
            currentClubId = null;
            alert('Test mode enabled - Club ID and Game Mode ID will be auto-generated');
        }
        
        async function loadProspects() {
            const clubId = document.getElementById('clubId').value.trim() || currentClubId || null;
            const url = clubId ? `/api/youth-academy/prospects/${clubId}` : '/api/youth-academy/prospects';
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) return; // No prospects yet
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load prospects');
                }
                
                const prospects = await response.json();
                displayProspects(prospects);
            } catch (error) {
                showError(error.message);
            }
        }
        
        function displayProspects(prospects) {
            const grid = document.getElementById('prospectsGrid');
            grid.innerHTML = '';
            
            if (prospects.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No prospects available. Generate some using the controls above.</p>';
                return;
            }
            
            prospects.forEach(prospect => {
                const card = document.createElement('div');
                card.className = `prospect-card ${prospect.status}`;
                
                const picFolder = prospect.profile_pic_folder || 'Anglosphere';
                const picSrc = prospect.profile_pic ? `/gfx/${picFolder}/${prospect.profile_pic}` : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23ddd" width="60" height="60"/></svg>';
                
                card.innerHTML = `
                    <div class="player-header">
                        <img src="${picSrc}" alt="${prospect.name}" class="player-profile-pic" onerror="this.src='data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'><rect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/></svg>'">
                        <div class="player-info">
                            <h3>${prospect.name}</h3>
                            ${prospect.heritage_group || prospect.name_structure ? `
                                <div style="font-size: 11px; color: #666; margin-top: 2px; margin-bottom: 4px;">
                                    ${prospect.heritage_group ? `<span>${prospect.heritage_group}</span>` : ''}
                                    ${prospect.heritage_group && prospect.name_structure ? ' â€¢ ' : ''}
                                    ${prospect.name_structure ? `<span>${prospect.name_structure}</span>` : ''}
                                </div>
                            ` : ''}
                            <span class="talent-badge talent-${prospect.talent_rating.toLowerCase()}">${prospect.talent_rating} Talent</span>
                            <div class="potential-range">Potential: ${prospect.potential_min}-${prospect.potential_max}</div>
                        </div>
                    </div>
                    ${prospect.status === 'available' ? `
                        <div class="player-actions">
                            <button class="btn-success" onclick="promoteProspect('${prospect.id}')">Promote to Academy</button>
                            <button class="btn-danger" onclick="rejectProspect('${prospect.id}')">Reject</button>
                        </div>
                    ` : `<div style="font-size: 12px; color: #666; margin-top: 10px;">Status: ${prospect.status}</div>`}
                `;
                
                grid.appendChild(card);
            });
        }
        
        async function promoteProspect(prospectId) {
            try {
                const response = await fetch(`/api/youth-academy/prospects/${prospectId}/promote`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to promote prospect');
                }
                
                await loadProspects();
                await loadAcademyPlayers();
                await checkCapacity();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function rejectAllProspects() {
            if (!confirm('Are you sure you want to reject ALL available prospects? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/youth-academy/prospects/reject-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to reject all prospects');
                }
                
                const data = await response.json();
                alert(`Successfully rejected ${data.rejected_count} prospect(s)`);
                loadProspects(); // Refresh the prospects list
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function rejectProspect(prospectId) {
            try {
                const response = await fetch(`/api/youth-academy/prospects/${prospectId}/reject`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to reject prospect');
                }
                
                await loadProspects();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function loadAcademyPlayers() {
            const clubId = document.getElementById('clubId').value.trim() || currentClubId || null;
            const url = clubId ? `/api/youth-academy/players/${clubId}` : '/api/youth-academy/players';
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) return;
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load academy players');
                }
                
                const players = await response.json();
                displayAcademyPlayers(players);
            } catch (error) {
                showError(error.message);
            }
        }
        
        function displayAcademyPlayers(players) {
            const grid = document.getElementById('academyGrid');
            grid.innerHTML = '';
            
            if (players.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No players in academy. Promote prospects from above.</p>';
                return;
            }
            
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'academy-player-card';
                
                const picFolder = player.profile_pic_folder || 'Anglosphere';
                const picSrc = player.profile_pic ? `/gfx/${picFolder}/${player.profile_pic}` : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23ddd" width="60" height="60"/></svg>';
                
                // Build attribute ranges HTML with change indicators
                let attrHTML = '';
                if (player.attribute_ranges) {
                    const attrs = Object.entries(player.attribute_ranges);
                    const previousRanges = window.previousAttributeRanges?.[player.id] || {};
                    attrHTML = '<div class="attribute-grid">';
                    attrs.forEach(([name, range]) => {
                        const prevRange = previousRanges[name];
                        let minClass = '';
                        let maxClass = '';
                        
                        // Check if min changed (went up = green, went down = red)
                        if (prevRange) {
                            if (range.min > prevRange.min) {
                                minClass = 'attr-increased';
                            } else if (range.min < prevRange.min) {
                                minClass = 'attr-decreased';
                            }
                            
                            // Check if max changed (went up = green, went down = red)
                            if (range.max > prevRange.max) {
                                maxClass = 'attr-increased';
                            } else if (range.max < prevRange.max) {
                                maxClass = 'attr-decreased';
                            }
                        }
                        
                        attrHTML += `
                            <div class="attribute-item">
                                <strong>${name}</strong>
                                <div class="attribute-value">
                                    <span class="${minClass}">${range.min}</span>-<span class="${maxClass}">${range.max}</span>
                                </div>
                            </div>
                        `;
                    });
                    attrHTML += '</div>';
                    
                    // Store current ranges for next comparison
                    if (!window.previousAttributeRanges) {
                        window.previousAttributeRanges = {};
                    }
                    window.previousAttributeRanges[player.id] = player.attribute_ranges;
                }
                
                const trainingPrograms = player.is_goalkeeper ? TRAINING_PROGRAMS_GK : TRAINING_PROGRAMS_OUTFIELD;
                const programOptions = trainingPrograms.map(p => 
                    `<option value="${p}" ${player.training_program === p ? 'selected' : ''}>${p}</option>`
                ).join('');
                
                const positionOptions = POSITIONS.map(p => 
                    `<option value="${p}" ${player.position === p ? 'selected' : ''}>${p}</option>`
                ).join('');
                
                card.innerHTML = `
                    <div class="player-header">
                        <img src="${picSrc}" alt="${player.name}" class="player-profile-pic" onerror="this.src='data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'><rect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/></svg>'">
                        <div class="player-info">
                            <h3>${player.name}</h3>
                            <span class="talent-badge talent-${player.talent_rating.toLowerCase()}">${player.talent_rating}</span>
                        </div>
                    </div>
                    
                    <div class="week-info">
                        Week ${player.weeks_in_academy} / ${player.weeks_to_promotion} (Joined week ${player.week_joined})
                    </div>
                    
                    ${player.actual_potential !== undefined ? `
                    <div class="diagnostic-info" style="background: #f0f0f0; padding: 8px; margin: 10px 0; border-radius: 4px; font-size: 11px;">
                        <strong>Diagnostics:</strong><br>
                        Potential: ${player.actual_potential}<br>
                        Birth Dev: ${player.birth_dev_pct !== null && player.birth_dev_pct !== undefined ? player.birth_dev_pct.toFixed(2) : 'N/A'}<br>
                        Base Training: ${player.base_training_pct !== null && player.base_training_pct !== undefined ? player.base_training_pct.toFixed(2) : 'N/A'}<br>
                        Growth Training: ${player.growth_training_pct !== null && player.growth_training_pct !== undefined ? player.growth_training_pct.toFixed(2) : 'N/A'}
                    </div>
                    ` : ''}
                    
                    <div class="attribute-ranges">
                        <h4>Attribute Ranges</h4>
                        ${attrHTML || '<p style="color: #666; font-size: 11px;">Ranges will appear after week 1</p>'}
                    </div>
                    
                    <div class="academy-controls">
                        <label>Position:</label>
                        <select id="position_${player.id}" onchange="updateAcademyPlayer('${player.id}')">
                            <option value="">None</option>
                            ${positionOptions}
                        </select>
                        
                        <label>Training Program:</label>
                        <select id="training_${player.id}" onchange="updateAcademyPlayer('${player.id}')">
                            <option value="">None</option>
                            ${programOptions}
                        </select>
                        
                        <div class="player-actions">
                            <button class="btn-success" onclick="promoteAcademyPlayer('${player.id}')">Promote Now</button>
                            <button class="btn-danger" onclick="releaseAcademyPlayer('${player.id}')">Release</button>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        async function updateAcademyPlayer(playerId) {
            const position = document.getElementById(`position_${playerId}`).value || null;
            const trainingProgram = document.getElementById(`training_${playerId}`).value || null;
            
            try {
                const response = await fetch(`/api/youth-academy/players/${playerId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        position: position,
                        training_program: trainingProgram
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to update player');
                }
                
                await loadAcademyPlayers();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function promoteAcademyPlayer(playerId) {
            try {
                const response = await fetch(`/api/youth-academy/players/${playerId}/promote`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to promote player');
                }
                
                await loadAcademyPlayers();
                await loadPromotedPlayers();  // Refresh promoted players after promotion
                await checkCapacity();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function loadPromotedPlayers() {
            const clubId = document.getElementById('clubId').value.trim() || currentClubId || null;
            const url = clubId ? `/api/youth-academy/promoted-players/${clubId}` : '/api/youth-academy/promoted-players';
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load promoted players');
                }
                
                const players = await response.json();
                displayPromotedPlayers(players);
            } catch (error) {
                showError(error.message);
            }
        }
        
        function displayPromotedPlayers(players) {
            const grid = document.getElementById('promotedPlayersGrid');
            grid.innerHTML = '';
            
            if (players.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No promoted players yet.</p>';
                return;
            }
            
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'academy-player-card';
                
                const picFolder = player.profile_pic_folder || 'Anglosphere';
                const picSrc = player.profile_pic ? `/gfx/${picFolder}/${player.profile_pic}` : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23ddd" width="60" height="60"/></svg>';
                
                // Build full attributes HTML
                let attrHTML = '';
                if (player.actual_attributes) {
                    const attrs = Object.entries(player.actual_attributes);
                    attrHTML = '<div class="attribute-grid">';
                    attrs.forEach(([name, value]) => {
                        attrHTML += `
                            <div class="attribute-item">
                                <strong>${name}</strong>
                                <div class="attribute-value">${value}</div>
                            </div>
                        `;
                    });
                    attrHTML += '</div>';
                }
                
                card.innerHTML = `
                    <div class="player-header">
                        <img src="${picSrc}" alt="${player.name}" class="player-profile-pic" onerror="this.src='data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'><rect fill=\\'%23ddd\\' width=\\'60\\' height=\\'60\\'/></svg>'">
                        <div class="player-info">
                            <h3>${player.name}</h3>
                            <span class="talent-badge">Promoted</span>
                        </div>
                    </div>
                    
                    <div class="diagnostic-info" style="background: #e8f5e9; padding: 8px; margin: 10px 0; border-radius: 4px; font-size: 11px;">
                        <strong>Full Stats:</strong><br>
                        Potential: ${player.potential}<br>
                        Birth Dev: ${player.birth_dev_pct !== null && player.birth_dev_pct !== undefined ? player.birth_dev_pct.toFixed(2) : 'N/A'}<br>
                        Base Training: ${player.base_training_pct !== null && player.base_training_pct !== undefined ? player.base_training_pct.toFixed(2) : 'N/A'}<br>
                        Growth Training: ${player.growth_training_pct !== null && player.growth_training_pct !== undefined ? player.growth_training_pct.toFixed(2) : 'N/A'}<br>
                        Position: ${player.position || 'Not set'}<br>
                        ${player.promoted_at ? `Promoted: ${new Date(player.promoted_at).toLocaleDateString()}` : ''}
                    </div>
                    
                    <div class="attribute-ranges">
                        <h4>Full Attributes</h4>
                        ${attrHTML || '<p style="color: #666; font-size: 11px;">No attributes available</p>'}
                    </div>
                    
                    ${player.position_traits && player.position_traits.length > 0 ? `
                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Position Traits:</strong> ${player.position_traits.join(', ')}
                    </div>
                    ` : ''}
                    
                    ${player.gainable_traits && player.gainable_traits.length > 0 ? `
                    <div style="margin-top: 5px; font-size: 11px;">
                        <strong>Gainable Traits:</strong> ${player.gainable_traits.join(', ')}
                    </div>
                    ` : ''}
                `;
                
                grid.appendChild(card);
            });
        }
        
        async function trainPromotedPlayers() {
            const clubId = document.getElementById('clubId').value.trim() || currentClubId || null;
            const trainingFacilities = parseInt(document.getElementById('trainingFacilities').value);
            const primaryProgram = document.getElementById('primaryProgram').value;
            const secondaryProgram = document.getElementById('secondaryProgram').value;
            const generalShare = 0.4; // Default general share
            
            try {
                const response = await fetch('/api/youth-academy/train-promoted-players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        club_id: clubId,
                        training_facilities: trainingFacilities,
                        primary_program: primaryProgram,
                        primary_share: 0.4,
                        secondary_program: secondaryProgram,
                        secondary_share: 0.2,
                        general_share: generalShare,
                        years_to_simulate: 14
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to train promoted players');
                }
                
                const data = await response.json();
                displayDevelopmentResults(data);
                
                // Scroll to section 4
                document.getElementById('section4').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showError(error.message);
            }
        }
        
        function displayDevelopmentResults(data) {
            const container = document.getElementById('developmentResults');
            container.innerHTML = '';
            
            try {
                const players = data.players;
                const dpBreakdown = data.development_points;
                
                // Validate data structure
                if (!players || !Array.isArray(players) || players.length === 0) {
                    container.innerHTML = '<p style="color: red;">Error: No player data received</p>';
                    container.style.display = 'block';
                    return;
                }
                
                if (!dpBreakdown || !Array.isArray(dpBreakdown) || dpBreakdown.length === 0) {
                    container.innerHTML = '<p style="color: red;">Error: No development points data received</p>';
                    container.style.display = 'block';
                    return;
                }
                
                // Get number of players from first snapshot
                if (!players[0].players || !Array.isArray(players[0].players) || players[0].players.length === 0) {
                    container.innerHTML = '<p style="color: red;">Error: No players in snapshot</p>';
                    container.style.display = 'block';
                    return;
                }
                
                const numPlayers = players[0].players.length;
                const playersGrid = document.createElement('div');
                playersGrid.className = 'players-grid';
                
                // Group by player instead of by year
                for (let playerIndex = 0; playerIndex < numPlayers; playerIndex++) {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    
                    // Get player name and potential from first snapshot
                    const firstSnapshot = players[0].players[playerIndex];
                    const firstDp = dpBreakdown[0].players[playerIndex];
                    const playerName = firstSnapshot.name;
                    const playerPotential = firstSnapshot.potential;
                    const profilePic = firstSnapshot.profile_pic || null;
                    const profilePicFolder = firstSnapshot.profile_pic_folder || 'Anglosphere';
                    const birthDp = (firstDp && firstDp.birth_dp) || 0;
                    const baseTrainingTotal = (firstDp && firstDp.base_training_total) || 0;
                    const growthTrainingTotal = (firstDp && firstDp.growth_training_total) || 0;
                    
                    // Constant info section
                    const constantInfoDiv = document.createElement('div');
                    constantInfoDiv.className = 'player-constant-info';
                    
                    // Profile picture
                    const picHtml = profilePic 
                        ? `<img src="/gfx/${profilePicFolder}/${profilePic}" alt="${playerName}" class="player-profile-pic">`
                        : '';
                    
                    constantInfoDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${picHtml}
                            <div style="flex: 1;">
                                <h4>${playerName} (Potential: ${playerPotential})</h4>
                                <div class="constant-stats">
                                    <div><strong>Birth DP:</strong> ${birthDp.toFixed(1)}</div>
                                    <div><strong>Base Training Total:</strong> ${baseTrainingTotal.toFixed(1)}</div>
                                    <div><strong>Growth Training Total:</strong> ${growthTrainingTotal.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    playerCard.appendChild(constantInfoDiv);
                    
                    // Get attribute names from first snapshot (sorted)
                    const firstPlayer = players[0].players[playerIndex];
                    const attrNames = Object.keys(firstPlayer.attributes).sort();
                    
                    // Create table for yearly progression
                    const table = document.createElement('table');
                    table.className = 'player-progression-table';
                    
                    // Build header row with all attribute columns
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `
                        <th>Age</th>
                        <th>Training Weeks</th>
                        ${attrNames.map(attr => `<th>${attr}</th>`).join('')}
                        <th>Base Training This Year</th>
                        <th>Growth Training This Year</th>
                        <th>Nominal Used This Year</th>
                        <th>Assigned DP This Year</th>
                    `;
                    const thead = document.createElement('thead');
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    tbody.id = `player_${playerIndex}_tbody`;
                    table.appendChild(tbody);
                    
                    // Loop through all years for this player
                    players.forEach((snapshot, yearIndex) => {
                        const player = snapshot.players[playerIndex];
                        const dp = dpBreakdown[yearIndex].players[playerIndex];
                        
                        // Safely get DP values with defaults
                        const baseTrainingThisYear = (dp && dp.base_training_this_year) || 0;
                        const growthTrainingThisYear = (dp && dp.growth_training_this_year) || 0;
                        const nominalUsedThisYear = (dp && dp.nominal_used_this_year) || 0;
                        const assignedDpThisYear = (dp && dp.assigned_dp_this_year) || 0;
                        
                        const ageYears = Math.floor(player.age_months / 12);
                        const ageMonths = player.age_months % 12;
                        
                        // Build data row with all attribute values
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ageYears}y${ageMonths}m</td>
                            <td>${player.training_weeks}</td>
                            ${attrNames.map(attr => `<td>${player.attributes[attr] || 0}</td>`).join('')}
                            <td>${baseTrainingThisYear.toFixed(1)}</td>
                            <td>${growthTrainingThisYear.toFixed(1)}</td>
                            <td>${nominalUsedThisYear.toFixed(1)}</td>
                            <td>${assignedDpThisYear.toFixed(1)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    playerCard.appendChild(table);
                    playersGrid.appendChild(playerCard);
                }
                
                container.appendChild(playersGrid);
                container.style.display = 'block';
            } catch (error) {
                console.error('Error displaying development results:', error);
                container.innerHTML = `<p style="color: red;">Error displaying results: ${error.message}</p>`;
                container.style.display = 'block';
            }
        }
        
        async function releaseAcademyPlayer(playerId) {
            if (!confirm('Are you sure you want to release this player from the academy?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/youth-academy/players/${playerId}/release`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to release player');
                }
                
                await loadAcademyPlayers();
                await loadPromotedPlayers();  // Refresh promoted players after promotion
                await checkCapacity();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function progressWeek() {
            const clubId = document.getElementById('clubId').value.trim() || currentClubId || null;
            const url = clubId ? `/api/youth-academy/progress-week/${clubId}` : '/api/youth-academy/progress-week';
            
            if (!confirm('Progress all academy players by 1 week?')) {
                return;
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to progress week');
                }
                
                await loadAcademyPlayers();
                await loadPromotedPlayers();  // Refresh promoted players after progress
            } catch (error) {
                showError(error.message);
            }
        }
        
        // Load random logo when page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadRandomLogo();
        });
    </script>
</body>
</html>
